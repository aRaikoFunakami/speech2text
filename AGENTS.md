このリポジトリで AI（例: GitHub Copilot）と人間が作業するための **契約**。
迷ったらこのファイルを最優先する。

プロジェクト概要・アーキテクチャ・起動方法・トラブルシューティングは → [README.md](./README.md) を参照。

---

## 1. TL;DR（最重要だけ）

- 作業開始前に [README.md](./README.md) と `instructions/` 配下の該当ファイルを確認する
- 変更は **1ステップずつ** 入れて、直後に必ず検証（tests/metrics）する
- SSE/WS 等は **自動で終わる** こと（timeout / close / スコープ制限）を最優先する
- ライブラリ管理は **`uv add`** を使う（`pip install` / `pip uninstall` 等は禁止）
- コミットは **1コミット＝1論点**、メッセージは `type(scope): subject` を厳守する（→ [instructions/git-commit.md](instructions/git-commit.md)）

---

## 2. instructions/ ガイド（条件付き読み込み）

作業内容に応じて、**必要なファイルだけ**を読むこと：

| ドキュメント | 読むべきタイミング |
|-------------|-------------------|
| **[instructions/dependency-management.md](instructions/dependency-management.md)** | ライブラリの追加・削除・更新を行うとき |
| **[instructions/work-directory.md](instructions/work-directory.md)** | 開発計画の作成・`work/` ディレクトリを使うとき |


### その他の参照ドキュメント

| ドキュメント | 確認するタイミング |
|-------------|-------------------|
| **[README.md](./README.md)** | プロジェクト全体の把握、起動方法の確認 |

**重要**: 一般的なフレームワークの知識だけで推測して作業しないこと。このプロジェクト固有のルールが各ドキュメントに記載されています。

---

## 3. カウントされる変更 / されない変更

### カウントされる（進捗）

- 新機能（回帰テスト必須）
- バグ修正（Fail→Pass テスト必須）
- 安定性：クラッシュ/パニック/例外の排除（回帰テスト必須）
- 終了性：タイムアウト/無限ループの排除（回帰テスト必須）
- 適合性：意味のあるテストカバレッジ追加
- UX：ユーザーに見える品質向上

### カウントされない（ドリフト防止）

- ツール/インフラだけ：成果に直結しない変更
- パフォーマンスだけ：終了性や精度に繋がらない最適化
- ドキュメントだけ：混乱を解消しない文書追加

---

## 4. Non-negotiables（絶対禁止）

- 特定ケースだけ通すハック禁止（host名・特定入力・マジック値で帳尻合わせ等）
- 仕様ショートカット禁止（「動くからOK」禁止）
- 例外握りつぶし禁止：プロジェクト標準のエラー方針を使う
- 無制限実行禁止：必ず timeout / スコープ制限をかける
- 巨大差分禁止：逸脱時は分割する
- `pip install` / `pip uninstall` 禁止：ライブラリの追加・削除は必ず `uv add` / `uv remove` を使い、`pyproject.toml` で一元管理する
- **計画中に勝手にソースコードの変更を始めない** — `work/` に計画書を作成中は実装に着手せず、ユーザーの承認を得てから開始

---

## 5. 証拠（Evidence）要件

| レベル | 内容 |
|-------|------|
| 最良 | 自動テスト（Fail→Pass） + 回帰 |
| 次点 | メトリクス（Before/After） + 再現手順 |
| 最低 | 手動確認ログ（スクショ/動画/チェックリスト） |
| 禁止 | 「改善した」宣言のみ |

| 主張 | 必要な証拠 |
| --- | --- |
| バグを修正した | Fail→Pass テスト |
| 性能が改善した | Before/After（数値） + 再現スクリプト |
| 終了性を改善した | timeout/無限ループ再現→解消テスト |

テスト結果を書く場合は**実行コマンドを明示**。未実行の場合は `not run (reason: ...)` と正直に書く。

---

## 6. 開発ループ（Single-step）

1) 現状確認（再現 or ベースライン取得）
2) 差異を1つ特定
3) 変更を1つ入れる
4) 直後に検証（tests/metrics）
5) ダメなら 2 に戻る

---

## 7. コミットメッセージ（概要）

- `type(scope): subject` — 詳細は [instructions/git-commit.md](instructions/git-commit.md)
- **1コミット＝1論点**
- 実行していないテストを「実行した」と書くことは禁止
- 秘匿情報をコミットログに書くことは禁止
